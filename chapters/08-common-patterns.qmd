# Common Patterns

## The Done Tool Pattern

Standard pattern for agent completion:

```lua
Tool "done" {
    description = "Signal task completion",
    input = {
        result = field.string{required = true}
    },
    function(args) return args.result end
}

Agent "worker" {
    system_prompt = "... Call done when finished.",
    toolsets = {"done"}
}

Procedure "main" {
    function()
        repeat
            Agent("worker").turn()
        until Tool.called("done")

        return {result = Tool.last_result("done")}
    end
}
```

## Tool Result Summarization

Force agent to explain tool results:

```lua
repeat
    Agent("researcher").turn()

    if Tool.called("search") then
        Agent("researcher").turn({
            inject = "Summarize the search results",
            tools = {}  -- No tools = must respond with text
        })
    end
until Tool.called("done")
```

## Human Approval Gate

```lua
local approved = Human.approve({
    message = "Proceed with deployment?",
    context = {version = version, env = environment}
})

if approved then
    deploy()
else
    Log.info("Cancelled by user")
end
```

## Multi-Agent Handoff

```lua
-- Researcher finds information
repeat
    Agent("researcher").turn()
until Tool.called("findings_ready")

-- Writer creates content
Agent("writer").turn({
    inject = "Write about: " .. Tool.last_result("findings_ready")
})

repeat
    Agent("writer").turn()
until Tool.called("done")
```

## Retry with Backoff

```lua
local max_attempts = 3
local attempt = 0

repeat
    attempt = attempt + 1
    Agent("worker").turn()

    if not Tool.called("done") and attempt < max_attempts then
        Agent("worker").turn({
            inject = "Please try again. Attempt " .. attempt .. " of " .. max_attempts
        })
    end
until Tool.called("done") or attempt >= max_attempts
```

## Batch Processing

```lua
local items = input.items
local results = {}

for i, item in ipairs(items) do
    State.set("current_item", i)

    Agent("processor").turn({
        inject = "Process: " .. item
    })

    repeat
        Agent("processor").turn()
    until Tool.called("item_done")

    results[i] = Tool.last_result("item_done")
    Tool.reset()  -- Reset for next item
end
```

## Iteration Safety

Always include max iterations:

```lua
local max_turns = 20
local turn_count = 0

repeat
    Agent("worker").turn()
    turn_count = turn_count + 1
until Tool.called("done") or turn_count >= max_turns

if not Tool.called("done") then
    Log.warn("Max turns reached without completion")
end
```
